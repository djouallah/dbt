



WITH price_staging AS (
  SELECT *
  FROM read_csv(
    getvariable('price_today_paths'),
    skip = 1,
    header = 0,
    all_varchar = 1,
    columns = {
      'I': 'VARCHAR',
      'DISPATCH': 'VARCHAR',
      'PRICE': 'VARCHAR',
      'xx': 'VARCHAR',
      'SETTLEMENTDATE': 'timestamp',
      'RUNNO': 'VARCHAR',
      'REGIONID': 'VARCHAR',
      'DISPATCHINTERVAL': 'VARCHAR',
      'INTERVENTION': 'VARCHAR',
      'RRP': 'VARCHAR',
      'EEP': 'VARCHAR',
      'ROP': 'VARCHAR',
      'APCFLAG': 'VARCHAR',
      'MARKETSUSPENDEDFLAG': 'VARCHAR',
      'LASTCHANGED': 'VARCHAR',
      'RAISE6SECRRP': 'VARCHAR',
      'RAISE6SECROP': 'VARCHAR',
      'RAISE6SECAPCFLAG': 'VARCHAR',
      'RAISE60SECRRP': 'VARCHAR',
      'RAISE60SECROP': 'VARCHAR',
      'RAISE60SECAPCFLAG': 'VARCHAR',
      'RAISE5MINRRP': 'VARCHAR',
      'RAISE5MINROP': 'VARCHAR',
      'RAISE5MINAPCFLAG': 'VARCHAR',
      'RAISEREGRRP': 'VARCHAR',
      'RAISEREGROP': 'VARCHAR',
      'RAISEREGAPCFLAG': 'VARCHAR',
      'LOWER6SECRRP': 'VARCHAR',
      'LOWER6SECROP': 'VARCHAR',
      'LOWER6SECAPCFLAG': 'VARCHAR',
      'LOWER60SECRRP': 'VARCHAR',
      'LOWER60SECROP': 'VARCHAR',
      'LOWER60SECAPCFLAG': 'VARCHAR',
      'LOWER5MINRRP': 'VARCHAR',
      'LOWER5MINROP': 'VARCHAR',
      'LOWER5MINAPCFLAG': 'VARCHAR',
      'LOWERREGRRP': 'VARCHAR',
      'LOWERREGROP': 'VARCHAR',
      'LOWERREGAPCFLAG': 'VARCHAR',
      'PRICE_STATUS': 'VARCHAR',
      'PRE_AP_ENERGY_PRICE': 'VARCHAR',
      'PRE_AP_RAISE6_PRICE': 'VARCHAR',
      'PRE_AP_RAISE60_PRICE': 'VARCHAR',
      'PRE_AP_RAISE5MIN_PRICE': 'VARCHAR',
      'PRE_AP_RAISEREG_PRICE': 'VARCHAR',
      'PRE_AP_LOWER6_PRICE': 'VARCHAR',
      'PRE_AP_LOWER60_PRICE': 'VARCHAR',
      'PRE_AP_LOWER5MIN_PRICE': 'VARCHAR',
      'PRE_AP_LOWERREG_PRICE': 'VARCHAR',
      'RAISE1SECRRP': 'VARCHAR',
      'RAISE1SECROP': 'VARCHAR',
      'RAISE1SECAPCFLAG': 'VARCHAR',
      'LOWER1SECRRP': 'VARCHAR',
      'LOWER1SECROP': 'VARCHAR',
      'LOWER1SECAPCFLAG': 'VARCHAR',
      'PRE_AP_RAISE1_PRICE': 'VARCHAR',
      'PRE_AP_LOWER1_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_ENERGY_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_RAISE6_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_RAISE60_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_RAISE5MIN_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_RAISEREG_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_LOWER6_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_LOWER60_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_LOWER5MIN_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_LOWERREG_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_RAISE1_PRICE': 'VARCHAR',
      'CUMUL_PRE_AP_LOWER1_PRICE': 'VARCHAR',
      'OCD_STATUS': 'VARCHAR',
      'MII_STATUS': 'VARCHAR'
    },
    filename = 1,
    null_padding = true,
    ignore_errors = 1,
    auto_detect = false,
    hive_partitioning = false
  )
  WHERE I = 'D' AND PRICE = 'PRICE'
)

SELECT
  REGIONID,
  CAST(RUNNO AS DOUBLE) AS RUNNO,
  CAST(DISPATCHINTERVAL AS DOUBLE) AS DISPATCHINTERVAL,
  CAST(INTERVENTION AS DOUBLE) AS INTERVENTION,
  CAST(RRP AS DOUBLE) AS RRP,
  CAST(EEP AS DOUBLE) AS EEP,
  CAST(ROP AS DOUBLE) AS ROP,
  CAST(APCFLAG AS DOUBLE) AS APCFLAG,
  CAST(MARKETSUSPENDEDFLAG AS DOUBLE) AS MARKETSUSPENDEDFLAG,
  CAST(RAISE6SECRRP AS DOUBLE) AS RAISE6SECRRP,
  CAST(RAISE6SECROP AS DOUBLE) AS RAISE6SECROP,
  CAST(RAISE6SECAPCFLAG AS DOUBLE) AS RAISE6SECAPCFLAG,
  CAST(RAISE60SECRRP AS DOUBLE) AS RAISE60SECRRP,
  CAST(RAISE60SECROP AS DOUBLE) AS RAISE60SECROP,
  CAST(RAISE60SECAPCFLAG AS DOUBLE) AS RAISE60SECAPCFLAG,
  CAST(RAISE5MINRRP AS DOUBLE) AS RAISE5MINRRP,
  CAST(RAISE5MINROP AS DOUBLE) AS RAISE5MINROP,
  CAST(RAISE5MINAPCFLAG AS DOUBLE) AS RAISE5MINAPCFLAG,
  CAST(RAISEREGRRP AS DOUBLE) AS RAISEREGRRP,
  CAST(RAISEREGROP AS DOUBLE) AS RAISEREGROP,
  CAST(RAISEREGAPCFLAG AS DOUBLE) AS RAISEREGAPCFLAG,
  CAST(LOWER6SECRRP AS DOUBLE) AS LOWER6SECRRP,
  CAST(LOWER6SECROP AS DOUBLE) AS LOWER6SECROP,
  CAST(LOWER6SECAPCFLAG AS DOUBLE) AS LOWER6SECAPCFLAG,
  CAST(LOWER60SECRRP AS DOUBLE) AS LOWER60SECRRP,
  CAST(LOWER60SECROP AS DOUBLE) AS LOWER60SECROP,
  CAST(LOWER60SECAPCFLAG AS DOUBLE) AS LOWER60SECAPCFLAG,
  CAST(LOWER5MINRRP AS DOUBLE) AS LOWER5MINRRP,
  CAST(LOWER5MINROP AS DOUBLE) AS LOWER5MINROP,
  CAST(LOWER5MINAPCFLAG AS DOUBLE) AS LOWER5MINAPCFLAG,
  CAST(LOWERREGRRP AS DOUBLE) AS LOWERREGRRP,
  CAST(LOWERREGROP AS DOUBLE) AS LOWERREGROP,
  CAST(LOWERREGAPCFLAG AS DOUBLE) AS LOWERREGAPCFLAG,
  CAST(PRE_AP_ENERGY_PRICE AS DOUBLE) AS PRE_AP_ENERGY_PRICE,
  CAST(PRE_AP_RAISE6_PRICE AS DOUBLE) AS PRE_AP_RAISE6_PRICE,
  CAST(PRE_AP_RAISE60_PRICE AS DOUBLE) AS PRE_AP_RAISE60_PRICE,
  CAST(PRE_AP_RAISE5MIN_PRICE AS DOUBLE) AS PRE_AP_RAISE5MIN_PRICE,
  CAST(PRE_AP_RAISEREG_PRICE AS DOUBLE) AS PRE_AP_RAISEREG_PRICE,
  CAST(PRE_AP_LOWER6_PRICE AS DOUBLE) AS PRE_AP_LOWER6_PRICE,
  CAST(PRE_AP_LOWER60_PRICE AS DOUBLE) AS PRE_AP_LOWER60_PRICE,
  CAST(PRE_AP_LOWER5MIN_PRICE AS DOUBLE) AS PRE_AP_LOWER5MIN_PRICE,
  CAST(PRE_AP_LOWERREG_PRICE AS DOUBLE) AS PRE_AP_LOWERREG_PRICE,
  CAST(RAISE1SECRRP AS DOUBLE) AS RAISE1SECRRP,
  CAST(RAISE1SECROP AS DOUBLE) AS RAISE1SECROP,
  CAST(RAISE1SECAPCFLAG AS DOUBLE) AS RAISE1SECAPCFLAG,
  CAST(LOWER1SECRRP AS DOUBLE) AS LOWER1SECRRP,
  CAST(LOWER1SECROP AS DOUBLE) AS LOWER1SECROP,
  CAST(LOWER1SECAPCFLAG AS DOUBLE) AS LOWER1SECAPCFLAG,
  CAST(PRE_AP_RAISE1_PRICE AS DOUBLE) AS PRE_AP_RAISE1_PRICE,
  CAST(PRE_AP_LOWER1_PRICE AS DOUBLE) AS PRE_AP_LOWER1_PRICE,
  CAST(CUMUL_PRE_AP_ENERGY_PRICE AS DOUBLE) AS CUMUL_PRE_AP_ENERGY_PRICE,
  CAST(CUMUL_PRE_AP_RAISE6_PRICE AS DOUBLE) AS CUMUL_PRE_AP_RAISE6_PRICE,
  CAST(CUMUL_PRE_AP_RAISE60_PRICE AS DOUBLE) AS CUMUL_PRE_AP_RAISE60_PRICE,
  CAST(CUMUL_PRE_AP_RAISE5MIN_PRICE AS DOUBLE) AS CUMUL_PRE_AP_RAISE5MIN_PRICE,
  CAST(CUMUL_PRE_AP_RAISEREG_PRICE AS DOUBLE) AS CUMUL_PRE_AP_RAISEREG_PRICE,
  CAST(CUMUL_PRE_AP_LOWER6_PRICE AS DOUBLE) AS CUMUL_PRE_AP_LOWER6_PRICE,
  CAST(CUMUL_PRE_AP_LOWER60_PRICE AS DOUBLE) AS CUMUL_PRE_AP_LOWER60_PRICE,
  CAST(CUMUL_PRE_AP_LOWER5MIN_PRICE AS DOUBLE) AS CUMUL_PRE_AP_LOWER5MIN_PRICE,
  CAST(CUMUL_PRE_AP_LOWERREG_PRICE AS DOUBLE) AS CUMUL_PRE_AP_LOWERREG_PRICE,
  CAST(CUMUL_PRE_AP_RAISE1_PRICE AS DOUBLE) AS CUMUL_PRE_AP_RAISE1_PRICE,
  CAST(CUMUL_PRE_AP_LOWER1_PRICE AS DOUBLE) AS CUMUL_PRE_AP_LOWER1_PRICE,
  SETTLEMENTDATE,
  CAST(SETTLEMENTDATE AS DATE) AS DATE,
  
    split_part(split_part(filename, '/', -1), '.', 1)
 AS file,
  CAST(YEAR(SETTLEMENTDATE) AS INT) AS YEAR
FROM price_staging