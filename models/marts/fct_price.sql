{{ config(
    materialized='incremental',
    unique_key=['file', 'REGIONID', 'SETTLEMENTDATE'],
    pre_hook="SET VARIABLE price_daily_paths = (SELECT COALESCE(NULLIF(list('zip://' || '{{ var('csv_archive_path') }}' || '/daily/year=' || substring(source_filename, 14, 4) || '/source_file=' || source_filename || '/data_0.zip/*.CSV'), []), ['']) FROM {{ ref('stg_csv_archive_log') }} WHERE source_type = 'daily')"
) }}

{% set csv_archive_path = var('csv_archive_path') %}

WITH price_staging AS (
  SELECT *
  FROM read_csv(
    getvariable('price_daily_paths'),
    skip = 1,
    header = 0,
    all_varchar = 1,
    columns = {
      'I': 'VARCHAR',
      'UNIT': 'VARCHAR',
      'XX': 'VARCHAR',
      'VERSION': 'VARCHAR',
      'SETTLEMENTDATE': 'VARCHAR',
      'RUNNO': 'VARCHAR',
      'REGIONID': 'VARCHAR',
      'INTERVENTION': 'VARCHAR',
      'RRP': 'VARCHAR',
      'EEP': 'VARCHAR',
      'ROP': 'VARCHAR',
      'APCFLAG': 'VARCHAR',
      'MARKETSUSPENDEDFLAG': 'VARCHAR',
      'TOTALDEMAND': 'VARCHAR',
      'DEMANDFORECAST': 'VARCHAR',
      'DISPATCHABLEGENERATION': 'VARCHAR',
      'DISPATCHABLELOAD': 'VARCHAR',
      'NETINTERCHANGE': 'VARCHAR',
      'EXCESSGENERATION': 'VARCHAR',
      'LOWER5MINDISPATCH': 'VARCHAR',
      'LOWER5MINIMPORT': 'VARCHAR',
      'LOWER5MINLOCALDISPATCH': 'VARCHAR',
      'LOWER5MINLOCALPRICE': 'VARCHAR',
      'LOWER5MINLOCALREQ': 'VARCHAR',
      'LOWER5MINPRICE': 'VARCHAR',
      'LOWER5MINREQ': 'VARCHAR',
      'LOWER5MINSUPPLYPRICE': 'VARCHAR',
      'LOWER60SECDISPATCH': 'VARCHAR',
      'LOWER60SECIMPORT': 'VARCHAR',
      'LOWER60SECLOCALDISPATCH': 'VARCHAR',
      'LOWER60SECLOCALPRICE': 'VARCHAR',
      'LOWER60SECLOCALREQ': 'VARCHAR',
      'LOWER60SECPRICE': 'VARCHAR',
      'LOWER60SECREQ': 'VARCHAR',
      'LOWER60SECSUPPLYPRICE': 'VARCHAR',
      'LOWER6SECDISPATCH': 'VARCHAR',
      'LOWER6SECIMPORT': 'VARCHAR',
      'LOWER6SECLOCALDISPATCH': 'VARCHAR',
      'LOWER6SECLOCALPRICE': 'VARCHAR',
      'LOWER6SECLOCALREQ': 'VARCHAR',
      'LOWER6SECPRICE': 'VARCHAR',
      'LOWER6SECREQ': 'VARCHAR',
      'LOWER6SECSUPPLYPRICE': 'VARCHAR',
      'RAISE5MINDISPATCH': 'VARCHAR',
      'RAISE5MINIMPORT': 'VARCHAR',
      'RAISE5MINLOCALDISPATCH': 'VARCHAR',
      'RAISE5MINLOCALPRICE': 'VARCHAR',
      'RAISE5MINLOCALREQ': 'VARCHAR',
      'RAISE5MINPRICE': 'VARCHAR',
      'RAISE5MINREQ': 'VARCHAR',
      'RAISE5MINSUPPLYPRICE': 'VARCHAR',
      'RAISE60SECDISPATCH': 'VARCHAR',
      'RAISE60SECIMPORT': 'VARCHAR',
      'RAISE60SECLOCALDISPATCH': 'VARCHAR',
      'RAISE60SECLOCALPRICE': 'VARCHAR',
      'RAISE60SECLOCALREQ': 'VARCHAR',
      'RAISE60SECPRICE': 'VARCHAR',
      'RAISE60SECREQ': 'VARCHAR',
      'RAISE60SECSUPPLYPRICE': 'VARCHAR',
      'RAISE6SECDISPATCH': 'VARCHAR',
      'RAISE6SECIMPORT': 'VARCHAR',
      'RAISE6SECLOCALDISPATCH': 'VARCHAR',
      'RAISE6SECLOCALPRICE': 'VARCHAR',
      'RAISE6SECLOCALREQ': 'VARCHAR',
      'RAISE6SECPRICE': 'VARCHAR',
      'RAISE6SECREQ': 'VARCHAR',
      'RAISE6SECSUPPLYPRICE': 'VARCHAR',
      'AGGREGATEDISPATCHERROR': 'VARCHAR',
      'AVAILABLEGENERATION': 'VARCHAR',
      'AVAILABLELOAD': 'VARCHAR',
      'INITIALSUPPLY': 'VARCHAR',
      'CLEAREDSUPPLY': 'VARCHAR',
      'LOWERREGIMPORT': 'VARCHAR',
      'LOWERREGLOCALDISPATCH': 'VARCHAR',
      'LOWERREGLOCALREQ': 'VARCHAR',
      'LOWERREGREQ': 'VARCHAR',
      'RAISEREGIMPORT': 'VARCHAR',
      'RAISEREGLOCALDISPATCH': 'VARCHAR',
      'RAISEREGLOCALREQ': 'VARCHAR',
      'RAISEREGREQ': 'VARCHAR',
      'RAISE5MINLOCALVIOLATION': 'VARCHAR',
      'RAISEREGLOCALVIOLATION': 'VARCHAR',
      'RAISE60SECLOCALVIOLATION': 'VARCHAR',
      'RAISE6SECLOCALVIOLATION': 'VARCHAR',
      'LOWER5MINLOCALVIOLATION': 'VARCHAR',
      'LOWERREGLOCALVIOLATION': 'VARCHAR',
      'LOWER60SECLOCALVIOLATION': 'VARCHAR',
      'LOWER6SECLOCALVIOLATION': 'VARCHAR',
      'RAISE5MINVIOLATION': 'VARCHAR',
      'RAISEREGVIOLATION': 'VARCHAR',
      'RAISE60SECVIOLATION': 'VARCHAR',
      'RAISE6SECVIOLATION': 'VARCHAR',
      'LOWER5MINVIOLATION': 'VARCHAR',
      'LOWERREGVIOLATION': 'VARCHAR',
      'LOWER60SECVIOLATION': 'VARCHAR',
      'LOWER6SECVIOLATION': 'VARCHAR',
      'RAISE6SECRRP': 'VARCHAR',
      'RAISE6SECROP': 'VARCHAR',
      'RAISE6SECAPCFLAG': 'VARCHAR',
      'RAISE60SECRRP': 'VARCHAR',
      'RAISE60SECROP': 'VARCHAR',
      'RAISE60SECAPCFLAG': 'VARCHAR',
      'RAISE5MINRRP': 'VARCHAR',
      'RAISE5MINROP': 'VARCHAR',
      'RAISE5MINAPCFLAG': 'VARCHAR',
      'RAISEREGRRP': 'VARCHAR',
      'RAISEREGROP': 'VARCHAR',
      'RAISEREGAPCFLAG': 'VARCHAR',
      'LOWER6SECRRP': 'VARCHAR',
      'LOWER6SECROP': 'VARCHAR',
      'LOWER6SECAPCFLAG': 'VARCHAR',
      'LOWER60SECRRP': 'VARCHAR',
      'LOWER60SECROP': 'VARCHAR',
      'LOWER60SECAPCFLAG': 'VARCHAR',
      'LOWER5MINRRP': 'VARCHAR',
      'LOWER5MINROP': 'VARCHAR',
      'LOWER5MINAPCFLAG': 'VARCHAR',
      'LOWERREGRRP': 'VARCHAR',
      'LOWERREGROP': 'VARCHAR',
      'LOWERREGAPCFLAG': 'VARCHAR',
      'RAISE6SECACTUALAVAILABILITY': 'VARCHAR',
      'RAISE60SECACTUALAVAILABILITY': 'VARCHAR',
      'RAISE5MINACTUALAVAILABILITY': 'VARCHAR',
      'RAISEREGACTUALAVAILABILITY': 'VARCHAR',
      'LOWER6SECACTUALAVAILABILITY': 'VARCHAR',
      'LOWER60SECACTUALAVAILABILITY': 'VARCHAR',
      'LOWER5MINACTUALAVAILABILITY': 'VARCHAR',
      'LOWERREGACTUALAVAILABILITY': 'VARCHAR',
      'LORSURPLUS': 'VARCHAR',
      'LRCSURPLUS': 'VARCHAR'
    },
    filename = 1,
    null_padding = true,
    ignore_errors = 1,
    auto_detect = false,
    hive_partitioning = false
  )
  WHERE I = 'D' AND UNIT = 'DREGION' AND VERSION = '3'
)

SELECT
  UNIT,
  REGIONID,
  CAST(VERSION AS DOUBLE) AS VERSION,
  CAST(RUNNO AS DOUBLE) AS RUNNO,
  CAST(INTERVENTION AS DOUBLE) AS INTERVENTION,
  CAST(RRP AS DOUBLE) AS RRP,
  CAST(EEP AS DOUBLE) AS EEP,
  CAST(ROP AS DOUBLE) AS ROP,
  CAST(APCFLAG AS DOUBLE) AS APCFLAG,
  CAST(MARKETSUSPENDEDFLAG AS DOUBLE) AS MARKETSUSPENDEDFLAG,
  CAST(TOTALDEMAND AS DOUBLE) AS TOTALDEMAND,
  CAST(DEMANDFORECAST AS DOUBLE) AS DEMANDFORECAST,
  CAST(DISPATCHABLEGENERATION AS DOUBLE) AS DISPATCHABLEGENERATION,
  CAST(DISPATCHABLELOAD AS DOUBLE) AS DISPATCHABLELOAD,
  CAST(NETINTERCHANGE AS DOUBLE) AS NETINTERCHANGE,
  CAST(EXCESSGENERATION AS DOUBLE) AS EXCESSGENERATION,
  CAST(LOWER5MINDISPATCH AS DOUBLE) AS LOWER5MINDISPATCH,
  CAST(LOWER5MINIMPORT AS DOUBLE) AS LOWER5MINIMPORT,
  CAST(LOWER5MINLOCALDISPATCH AS DOUBLE) AS LOWER5MINLOCALDISPATCH,
  CAST(LOWER5MINLOCALPRICE AS DOUBLE) AS LOWER5MINLOCALPRICE,
  CAST(LOWER5MINLOCALREQ AS DOUBLE) AS LOWER5MINLOCALREQ,
  CAST(LOWER5MINPRICE AS DOUBLE) AS LOWER5MINPRICE,
  CAST(LOWER5MINREQ AS DOUBLE) AS LOWER5MINREQ,
  CAST(LOWER5MINSUPPLYPRICE AS DOUBLE) AS LOWER5MINSUPPLYPRICE,
  CAST(LOWER60SECDISPATCH AS DOUBLE) AS LOWER60SECDISPATCH,
  CAST(LOWER60SECIMPORT AS DOUBLE) AS LOWER60SECIMPORT,
  CAST(LOWER60SECLOCALDISPATCH AS DOUBLE) AS LOWER60SECLOCALDISPATCH,
  CAST(LOWER60SECLOCALPRICE AS DOUBLE) AS LOWER60SECLOCALPRICE,
  CAST(LOWER60SECLOCALREQ AS DOUBLE) AS LOWER60SECLOCALREQ,
  CAST(LOWER60SECPRICE AS DOUBLE) AS LOWER60SECPRICE,
  CAST(LOWER60SECREQ AS DOUBLE) AS LOWER60SECREQ,
  CAST(LOWER60SECSUPPLYPRICE AS DOUBLE) AS LOWER60SECSUPPLYPRICE,
  CAST(LOWER6SECDISPATCH AS DOUBLE) AS LOWER6SECDISPATCH,
  CAST(LOWER6SECIMPORT AS DOUBLE) AS LOWER6SECIMPORT,
  CAST(LOWER6SECLOCALDISPATCH AS DOUBLE) AS LOWER6SECLOCALDISPATCH,
  CAST(LOWER6SECLOCALPRICE AS DOUBLE) AS LOWER6SECLOCALPRICE,
  CAST(LOWER6SECLOCALREQ AS DOUBLE) AS LOWER6SECLOCALREQ,
  CAST(LOWER6SECPRICE AS DOUBLE) AS LOWER6SECPRICE,
  CAST(LOWER6SECREQ AS DOUBLE) AS LOWER6SECREQ,
  CAST(LOWER6SECSUPPLYPRICE AS DOUBLE) AS LOWER6SECSUPPLYPRICE,
  CAST(RAISE5MINDISPATCH AS DOUBLE) AS RAISE5MINDISPATCH,
  CAST(RAISE5MINIMPORT AS DOUBLE) AS RAISE5MINIMPORT,
  CAST(RAISE5MINLOCALDISPATCH AS DOUBLE) AS RAISE5MINLOCALDISPATCH,
  CAST(RAISE5MINLOCALPRICE AS DOUBLE) AS RAISE5MINLOCALPRICE,
  CAST(RAISE5MINLOCALREQ AS DOUBLE) AS RAISE5MINLOCALREQ,
  CAST(RAISE5MINPRICE AS DOUBLE) AS RAISE5MINPRICE,
  CAST(RAISE5MINREQ AS DOUBLE) AS RAISE5MINREQ,
  CAST(RAISE5MINSUPPLYPRICE AS DOUBLE) AS RAISE5MINSUPPLYPRICE,
  CAST(RAISE60SECDISPATCH AS DOUBLE) AS RAISE60SECDISPATCH,
  CAST(RAISE60SECIMPORT AS DOUBLE) AS RAISE60SECIMPORT,
  CAST(RAISE60SECLOCALDISPATCH AS DOUBLE) AS RAISE60SECLOCALDISPATCH,
  CAST(RAISE60SECLOCALPRICE AS DOUBLE) AS RAISE60SECLOCALPRICE,
  CAST(RAISE60SECLOCALREQ AS DOUBLE) AS RAISE60SECLOCALREQ,
  CAST(RAISE60SECPRICE AS DOUBLE) AS RAISE60SECPRICE,
  CAST(RAISE60SECREQ AS DOUBLE) AS RAISE60SECREQ,
  CAST(RAISE60SECSUPPLYPRICE AS DOUBLE) AS RAISE60SECSUPPLYPRICE,
  CAST(RAISE6SECDISPATCH AS DOUBLE) AS RAISE6SECDISPATCH,
  CAST(RAISE6SECIMPORT AS DOUBLE) AS RAISE6SECIMPORT,
  CAST(RAISE6SECLOCALDISPATCH AS DOUBLE) AS RAISE6SECLOCALDISPATCH,
  CAST(RAISE6SECLOCALPRICE AS DOUBLE) AS RAISE6SECLOCALPRICE,
  CAST(RAISE6SECLOCALREQ AS DOUBLE) AS RAISE6SECLOCALREQ,
  CAST(RAISE6SECPRICE AS DOUBLE) AS RAISE6SECPRICE,
  CAST(RAISE6SECREQ AS DOUBLE) AS RAISE6SECREQ,
  CAST(RAISE6SECSUPPLYPRICE AS DOUBLE) AS RAISE6SECSUPPLYPRICE,
  CAST(AGGREGATEDISPATCHERROR AS DOUBLE) AS AGGREGATEDISPATCHERROR,
  CAST(AVAILABLEGENERATION AS DOUBLE) AS AVAILABLEGENERATION,
  CAST(AVAILABLELOAD AS DOUBLE) AS AVAILABLELOAD,
  CAST(INITIALSUPPLY AS DOUBLE) AS INITIALSUPPLY,
  CAST(CLEAREDSUPPLY AS DOUBLE) AS CLEAREDSUPPLY,
  CAST(LOWERREGIMPORT AS DOUBLE) AS LOWERREGIMPORT,
  CAST(LOWERREGLOCALDISPATCH AS DOUBLE) AS LOWERREGLOCALDISPATCH,
  CAST(LOWERREGLOCALREQ AS DOUBLE) AS LOWERREGLOCALREQ,
  CAST(LOWERREGREQ AS DOUBLE) AS LOWERREGREQ,
  CAST(RAISEREGIMPORT AS DOUBLE) AS RAISEREGIMPORT,
  CAST(RAISEREGLOCALDISPATCH AS DOUBLE) AS RAISEREGLOCALDISPATCH,
  CAST(RAISEREGLOCALREQ AS DOUBLE) AS RAISEREGLOCALREQ,
  CAST(RAISEREGREQ AS DOUBLE) AS RAISEREGREQ,
  CAST(RAISE5MINLOCALVIOLATION AS DOUBLE) AS RAISE5MINLOCALVIOLATION,
  CAST(RAISEREGLOCALVIOLATION AS DOUBLE) AS RAISEREGLOCALVIOLATION,
  CAST(RAISE60SECLOCALVIOLATION AS DOUBLE) AS RAISE60SECLOCALVIOLATION,
  CAST(RAISE6SECLOCALVIOLATION AS DOUBLE) AS RAISE6SECLOCALVIOLATION,
  CAST(LOWER5MINLOCALVIOLATION AS DOUBLE) AS LOWER5MINLOCALVIOLATION,
  CAST(LOWERREGLOCALVIOLATION AS DOUBLE) AS LOWERREGLOCALVIOLATION,
  CAST(LOWER60SECLOCALVIOLATION AS DOUBLE) AS LOWER60SECLOCALVIOLATION,
  CAST(LOWER6SECLOCALVIOLATION AS DOUBLE) AS LOWER6SECLOCALVIOLATION,
  CAST(RAISE5MINVIOLATION AS DOUBLE) AS RAISE5MINVIOLATION,
  CAST(RAISEREGVIOLATION AS DOUBLE) AS RAISEREGVIOLATION,
  CAST(RAISE60SECVIOLATION AS DOUBLE) AS RAISE60SECVIOLATION,
  CAST(RAISE6SECVIOLATION AS DOUBLE) AS RAISE6SECVIOLATION,
  CAST(LOWER5MINVIOLATION AS DOUBLE) AS LOWER5MINVIOLATION,
  CAST(LOWERREGVIOLATION AS DOUBLE) AS LOWERREGVIOLATION,
  CAST(LOWER60SECVIOLATION AS DOUBLE) AS LOWER60SECVIOLATION,
  CAST(LOWER6SECVIOLATION AS DOUBLE) AS LOWER6SECVIOLATION,
  CAST(RAISE6SECRRP AS DOUBLE) AS RAISE6SECRRP,
  CAST(RAISE6SECROP AS DOUBLE) AS RAISE6SECROP,
  CAST(RAISE6SECAPCFLAG AS DOUBLE) AS RAISE6SECAPCFLAG,
  CAST(RAISE60SECRRP AS DOUBLE) AS RAISE60SECRRP,
  CAST(RAISE60SECROP AS DOUBLE) AS RAISE60SECROP,
  CAST(RAISE60SECAPCFLAG AS DOUBLE) AS RAISE60SECAPCFLAG,
  CAST(RAISE5MINRRP AS DOUBLE) AS RAISE5MINRRP,
  CAST(RAISE5MINROP AS DOUBLE) AS RAISE5MINROP,
  CAST(RAISE5MINAPCFLAG AS DOUBLE) AS RAISE5MINAPCFLAG,
  CAST(RAISEREGRRP AS DOUBLE) AS RAISEREGRRP,
  CAST(RAISEREGROP AS DOUBLE) AS RAISEREGROP,
  CAST(RAISEREGAPCFLAG AS DOUBLE) AS RAISEREGAPCFLAG,
  CAST(LOWER6SECRRP AS DOUBLE) AS LOWER6SECRRP,
  CAST(LOWER6SECROP AS DOUBLE) AS LOWER6SECROP,
  CAST(LOWER6SECAPCFLAG AS DOUBLE) AS LOWER6SECAPCFLAG,
  CAST(LOWER60SECRRP AS DOUBLE) AS LOWER60SECRRP,
  CAST(LOWER60SECROP AS DOUBLE) AS LOWER60SECROP,
  CAST(LOWER60SECAPCFLAG AS DOUBLE) AS LOWER60SECAPCFLAG,
  CAST(LOWER5MINRRP AS DOUBLE) AS LOWER5MINRRP,
  CAST(LOWER5MINROP AS DOUBLE) AS LOWER5MINROP,
  CAST(LOWER5MINAPCFLAG AS DOUBLE) AS LOWER5MINAPCFLAG,
  CAST(LOWERREGRRP AS DOUBLE) AS LOWERREGRRP,
  CAST(LOWERREGROP AS DOUBLE) AS LOWERREGROP,
  CAST(LOWERREGAPCFLAG AS DOUBLE) AS LOWERREGAPCFLAG,
  CAST(RAISE6SECACTUALAVAILABILITY AS DOUBLE) AS RAISE6SECACTUALAVAILABILITY,
  CAST(RAISE60SECACTUALAVAILABILITY AS DOUBLE) AS RAISE60SECACTUALAVAILABILITY,
  CAST(RAISE5MINACTUALAVAILABILITY AS DOUBLE) AS RAISE5MINACTUALAVAILABILITY,
  CAST(RAISEREGACTUALAVAILABILITY AS DOUBLE) AS RAISEREGACTUALAVAILABILITY,
  CAST(LOWER6SECACTUALAVAILABILITY AS DOUBLE) AS LOWER6SECACTUALAVAILABILITY,
  CAST(LOWER60SECACTUALAVAILABILITY AS DOUBLE) AS LOWER60SECACTUALAVAILABILITY,
  CAST(LOWER5MINACTUALAVAILABILITY AS DOUBLE) AS LOWER5MINACTUALAVAILABILITY,
  CAST(LOWERREGACTUALAVAILABILITY AS DOUBLE) AS LOWERREGACTUALAVAILABILITY,
  CAST(LORSURPLUS AS DOUBLE) AS LORSURPLUS,
  CAST(LRCSURPLUS AS DOUBLE) AS LRCSURPLUS,
  {{ parse_filename('filename') }} AS file,
  CAST(SETTLEMENTDATE AS TIMESTAMP) AS SETTLEMENTDATE,
  CAST(SETTLEMENTDATE AS DATE) AS DATE,
  CAST(YEAR(CAST(SETTLEMENTDATE AS TIMESTAMP)) AS INT) AS YEAR
FROM price_staging
